<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FalaVIP Music Player - Controle</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            padding: 20px 0;
            margin-bottom: 30px;
        }

        header h1 {
            font-size: 2rem;
            background: linear-gradient(90deg, #00d9ff, #00ff88);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .status-bar {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #ff4444;
        }

        .status-indicator.connected {
            background: #00ff88;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
        }

        .card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .card h2 {
            font-size: 1.2rem;
            margin-bottom: 20px;
            color: #00d9ff;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Player Controls */
        .now-playing {
            text-align: center;
            padding: 20px;
            background: rgba(0, 217, 255, 0.1);
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .now-playing .song-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .now-playing .song-status {
            color: #888;
            font-size: 0.9rem;
        }

        .player-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .player-controls button {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: none;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .player-controls button:hover {
            background: #00d9ff;
            transform: scale(1.1);
        }

        /* Volume Control */
        .volume-control {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .volume-control input[type="range"] {
            flex: 1;
            height: 8px;
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.2);
            -webkit-appearance: none;
        }

        .volume-control input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #00d9ff;
            cursor: pointer;
        }

        .volume-value {
            min-width: 50px;
            text-align: right;
            font-weight: bold;
        }

        /* Tables */
        .schedule-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .schedule-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .schedule-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .schedule-info {
            flex: 1;
        }

        .schedule-time {
            font-weight: bold;
            color: #00ff88;
        }

        .btn-delete {
            background: rgba(255, 68, 68, 0.2);
            color: #ff4444;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
        }

        .btn-delete:hover {
            background: rgba(255, 68, 68, 0.4);
        }

        /* Forms */
        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #888;
            font-size: 0.9rem;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.05);
            color: #fff;
            font-size: 1rem;
        }

        .form-row {
            display: flex;
            gap: 10px;
        }

        .form-row .form-group {
            flex: 1;
        }

        .btn-primary {
            width: 100%;
            padding: 12px;
            background: linear-gradient(90deg, #00d9ff, #00ff88);
            border: none;
            border-radius: 8px;
            color: #1a1a2e;
            font-weight: bold;
            font-size: 1rem;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
        }

        /* Music List */
        .music-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .music-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .music-item:hover {
            background: rgba(0, 217, 255, 0.2);
        }

        .music-item.is-ad {
            border-left: 3px solid #ff9800;
        }

        .music-name {
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .music-actions {
            display: flex;
            gap: 8px;
        }

        .btn-small {
            padding: 6px 10px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            font-size: 0.85rem;
        }

        .btn-play-next {
            background: rgba(0, 255, 136, 0.2);
            color: #00ff88;
        }

        /* Upload */
        .upload-area {
            border: 2px dashed rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 15px;
        }

        .upload-area:hover {
            border-color: #00d9ff;
            background: rgba(0, 217, 255, 0.1);
        }

        .upload-area input {
            display: none;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .checkbox-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
        }

        /* Toast Notifications */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #00ff88;
            color: #1a1a2e;
            padding: 15px 25px;
            border-radius: 8px;
            font-weight: bold;
            transform: translateX(150%);
            transition: transform 0.3s;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.error {
            background: #ff4444;
            color: #fff;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>FalaVIP Music Player</h1>
            <div class="status-bar">
                <div class="status-indicator" id="statusIndicator"></div>
                <span id="statusText">Desconectado</span>
            </div>
        </header>

        <div class="grid">
            <!-- Player Control -->
            <div class="card">
                <h2>üéµ Player</h2>
                <div class="now-playing">
                    <div class="song-title" id="currentSong">Nenhuma m√∫sica</div>
                    <div class="song-status" id="playingStatus">Parado</div>
                </div>
                <div class="player-controls">
                    <button onclick="playerPause()" title="Pausar">‚è∏Ô∏è</button>
                    <button onclick="playerPlay()" title="Play">‚ñ∂Ô∏è</button>
                    <button onclick="playerSkip()" title="Pr√≥xima">‚è≠Ô∏è</button>
                </div>
                <div class="volume-control">
                    <span>üîä</span>
                    <input type="range" id="volumeSlider" min="0" max="100" value="50" oninput="updateVolume(this.value)">
                    <span class="volume-value" id="volumeValue">50%</span>
                </div>
            </div>

            <!-- Volume Schedules -->
            <div class="card">
                <h2>üìÖ Agendamento de Volume</h2>
                <div class="schedule-list" id="volumeScheduleList">
                    <!-- Itens ser√£o adicionados via JS -->
                </div>
                <hr style="border-color: rgba(255,255,255,0.1); margin: 15px 0;">
                <form onsubmit="addVolumeSchedule(event)">
                    <div class="form-row">
                        <div class="form-group">
                            <label>In√≠cio</label>
                            <input type="time" id="scheduleStart" required>
                        </div>
                        <div class="form-group">
                            <label>Fim</label>
                            <input type="time" id="scheduleEnd" required>
                        </div>
                        <div class="form-group">
                            <label>Volume</label>
                            <input type="number" id="scheduleVolume" min="0" max="100" value="50" required>
                        </div>
                    </div>
                    <button type="submit" class="btn-primary">Adicionar Agendamento</button>
                </form>
            </div>

            <!-- Ad Schedules -->
            <div class="card">
                <h2>üì¢ Propagandas Agendadas</h2>
                <div class="schedule-list" id="adScheduleList">
                    <!-- Itens ser√£o adicionados via JS -->
                </div>
                <hr style="border-color: rgba(255,255,255,0.1); margin: 15px 0;">
                <form onsubmit="addAdSchedule(event)">
                    <div class="form-group">
                        <label>M√∫sica (Propaganda)</label>
                        <select id="adMusic" required>
                            <!-- Op√ß√µes ser√£o adicionadas via JS -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Intervalo (minutos)</label>
                        <input type="number" id="adInterval" min="1" value="30" required>
                    </div>
                    <button type="submit" class="btn-primary">Adicionar Propaganda</button>
                </form>
            </div>

            <!-- Scheduled Songs -->
            <div class="card">
                <h2>‚è∞ M√∫sicas Agendadas</h2>
                <div class="schedule-list" id="scheduledSongList">
                    <!-- Itens ser√£o adicionados via JS -->
                </div>
                <hr style="border-color: rgba(255,255,255,0.1); margin: 15px 0;">
                <form onsubmit="addScheduledSong(event)">
                    <div class="form-group">
                        <label>M√∫sica</label>
                        <select id="songMusic" required>
                            <!-- Op√ß√µes ser√£o adicionadas via JS -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Hor√°rio</label>
                        <input type="time" id="songTime" required>
                    </div>
                    <button type="submit" class="btn-primary">Agendar M√∫sica</button>
                </form>
            </div>

            <!-- Music Library -->
            <div class="card" style="grid-column: span 2;">
                <h2>üé∂ Biblioteca de M√∫sicas</h2>
                <div class="upload-area" onclick="document.getElementById('fileInput').click()">
                    <input type="file" id="fileInput" accept="audio/*" multiple onchange="uploadFiles(this.files)">
                    <p>üì§ Clique ou arraste arquivos para fazer upload</p>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="uploadAsAd">
                    <label for="uploadAsAd">Marcar como propaganda</label>
                </div>
                <div class="music-list" id="musicList">
                    <!-- Itens ser√£o adicionados via JS -->
                </div>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        const API_URL = window.location.origin;
        let ws;
        let musicList = [];
        let settings = {};

        // WebSocket Connection
        function connectWebSocket() {
            const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(`${wsProtocol}//${window.location.host}/ws`);

            ws.onopen = () => {
                updateStatus(true);
            };

            ws.onclose = () => {
                updateStatus(false);
                setTimeout(connectWebSocket, 3000);
            };

            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                handleMessage(data);
            };
        }

        function handleMessage(data) {
            switch (data.type) {
                case 'init':
                    settings = data.settings;
                    document.getElementById('volumeSlider').value = settings.volume * 100;
                    document.getElementById('volumeValue').textContent = Math.round(settings.volume * 100) + '%';
                    renderVolumeSchedules(settings.volume_schedules);
                    renderAdSchedules(settings.ad_schedules);
                    renderScheduledSongs(settings.scheduled_songs);
                    updatePlayerStatus(settings.player_status);
                    break;

                case 'player_status':
                    updatePlayerStatus(data);
                    break;

                case 'volume_change':
                    document.getElementById('volumeSlider').value = data.volume * 100;
                    document.getElementById('volumeValue').textContent = Math.round(data.volume * 100) + '%';
                    break;

                case 'music_added':
                case 'music_deleted':
                case 'schedule_updated':
                    loadSettings();
                    loadMusic();
                    break;
            }
        }

        function updateStatus(connected) {
            const indicator = document.getElementById('statusIndicator');
            const text = document.getElementById('statusText');

            if (connected) {
                indicator.classList.add('connected');
                text.textContent = 'Conectado';
            } else {
                indicator.classList.remove('connected');
                text.textContent = 'Desconectado';
            }
        }

        function updatePlayerStatus(status) {
            const songEl = document.getElementById('currentSong');
            const statusEl = document.getElementById('playingStatus');

            if (status.current_song) {
                songEl.textContent = status.current_song;
                statusEl.textContent = status.is_playing ? '‚ñ∂Ô∏è Tocando' : '‚è∏Ô∏è Pausado';
            } else {
                songEl.textContent = 'Nenhuma m√∫sica';
                statusEl.textContent = status.connected ? 'Aguardando' : 'Player desconectado';
            }
        }

        // API Calls
        async function loadMusic() {
            try {
                const res = await fetch(`${API_URL}/api/music/list`);
                musicList = await res.json();
                renderMusicList();
                updateMusicSelects();
            } catch (e) {
                console.error('Erro ao carregar m√∫sicas:', e);
            }
        }

        async function loadSettings() {
            try {
                const res = await fetch(`${API_URL}/api/settings`);
                settings = await res.json();
                renderVolumeSchedules(settings.volume_schedules);
                renderAdSchedules(settings.ad_schedules);
                renderScheduledSongs(settings.scheduled_songs);
            } catch (e) {
                console.error('Erro ao carregar configura√ß√µes:', e);
            }
        }

        async function updateVolume(value) {
            document.getElementById('volumeValue').textContent = value + '%';
            try {
                await fetch(`${API_URL}/api/settings/volume`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ volume: value / 100 })
                });
            } catch (e) {
                showToast('Erro ao atualizar volume', true);
            }
        }

        async function playerPlay() {
            await fetch(`${API_URL}/api/player/play`, { method: 'POST' });
        }

        async function playerPause() {
            await fetch(`${API_URL}/api/player/pause`, { method: 'POST' });
        }

        async function playerSkip() {
            await fetch(`${API_URL}/api/player/skip`, { method: 'POST' });
        }

        async function playNext(musicId) {
            await fetch(`${API_URL}/api/player/next`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ music_id: musicId })
            });
            showToast('M√∫sica ser√° a pr√≥xima!');
        }

        async function deleteMusic(musicId) {
            if (!confirm('Tem certeza que deseja excluir esta m√∫sica?')) return;

            try {
                await fetch(`${API_URL}/api/music/${musicId}`, { method: 'DELETE' });
                showToast('M√∫sica exclu√≠da!');
                loadMusic();
            } catch (e) {
                showToast('Erro ao excluir m√∫sica', true);
            }
        }

        async function uploadFiles(files) {
            const isAd = document.getElementById('uploadAsAd').checked;

            for (const file of files) {
                const formData = new FormData();
                formData.append('file', file);

                try {
                    await fetch(`${API_URL}/api/music/upload?is_ad=${isAd}`, {
                        method: 'POST',
                        body: formData
                    });
                    showToast(`"${file.name}" enviado!`);
                } catch (e) {
                    showToast(`Erro ao enviar "${file.name}"`, true);
                }
            }

            loadMusic();
        }

        async function addVolumeSchedule(event) {
            event.preventDefault();

            const data = {
                time_start: document.getElementById('scheduleStart').value,
                time_end: document.getElementById('scheduleEnd').value,
                volume: document.getElementById('scheduleVolume').value / 100
            };

            try {
                await fetch(`${API_URL}/api/settings/volume-schedule`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                showToast('Agendamento adicionado!');
                event.target.reset();
            } catch (e) {
                showToast('Erro ao adicionar agendamento', true);
            }
        }

        async function deleteVolumeSchedule(id) {
            await fetch(`${API_URL}/api/settings/volume-schedule/${id}`, { method: 'DELETE' });
            showToast('Agendamento removido!');
        }

        async function addAdSchedule(event) {
            event.preventDefault();

            const data = {
                music_id: document.getElementById('adMusic').value,
                interval_minutes: parseInt(document.getElementById('adInterval').value),
                enabled: true
            };

            try {
                await fetch(`${API_URL}/api/settings/ad-schedule`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                showToast('Propaganda agendada!');
                event.target.reset();
            } catch (e) {
                showToast('Erro ao agendar propaganda', true);
            }
        }

        async function deleteAdSchedule(id) {
            await fetch(`${API_URL}/api/settings/ad-schedule/${id}`, { method: 'DELETE' });
            showToast('Propaganda removida!');
        }

        async function addScheduledSong(event) {
            event.preventDefault();

            const data = {
                music_id: document.getElementById('songMusic').value,
                time: document.getElementById('songTime').value,
                repeat_daily: true
            };

            try {
                await fetch(`${API_URL}/api/settings/scheduled-song`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                showToast('M√∫sica agendada!');
                event.target.reset();
            } catch (e) {
                showToast('Erro ao agendar m√∫sica', true);
            }
        }

        async function deleteScheduledSong(id) {
            await fetch(`${API_URL}/api/settings/scheduled-song/${id}`, { method: 'DELETE' });
            showToast('Agendamento removido!');
        }

        // Render Functions
        function renderMusicList() {
            const container = document.getElementById('musicList');
            container.innerHTML = musicList.map(music => `
                <div class="music-item ${music.is_ad ? 'is-ad' : ''}">
                    <span class="music-name">${music.is_ad ? 'üì¢ ' : 'üéµ '}${music.original_name}</span>
                    <div class="music-actions">
                        <button class="btn-small btn-play-next" onclick="playNext('${music.id}')">‚ñ∂Ô∏è Pr√≥xima</button>
                        <button class="btn-small btn-delete" onclick="deleteMusic('${music.id}')">üóëÔ∏è</button>
                    </div>
                </div>
            `).join('');
        }

        function updateMusicSelects() {
            const adSelect = document.getElementById('adMusic');
            const songSelect = document.getElementById('songMusic');

            const options = musicList.map(m => `<option value="${m.id}">${m.original_name}</option>`).join('');

            adSelect.innerHTML = options;
            songSelect.innerHTML = options;
        }

        function renderVolumeSchedules(schedules) {
            const container = document.getElementById('volumeScheduleList');
            container.innerHTML = schedules.map(s => `
                <div class="schedule-item">
                    <div class="schedule-info">
                        <span class="schedule-time">${s.time_start} - ${s.time_end}</span>
                        <span> ‚Üí Volume: ${Math.round(s.volume * 100)}%</span>
                    </div>
                    <button class="btn-delete" onclick="deleteVolumeSchedule(${s.id})">üóëÔ∏è</button>
                </div>
            `).join('') || '<p style="color:#888;text-align:center;">Nenhum agendamento</p>';
        }

        function renderAdSchedules(schedules) {
            const container = document.getElementById('adScheduleList');
            container.innerHTML = schedules.map(s => `
                <div class="schedule-item">
                    <div class="schedule-info">
                        <span class="schedule-time">A cada ${s.interval_minutes} min</span>
                        <span> ‚Üí ${s.original_name}</span>
                    </div>
                    <button class="btn-delete" onclick="deleteAdSchedule(${s.id})">üóëÔ∏è</button>
                </div>
            `).join('') || '<p style="color:#888;text-align:center;">Nenhuma propaganda</p>';
        }

        function renderScheduledSongs(schedules) {
            const container = document.getElementById('scheduledSongList');
            container.innerHTML = schedules.map(s => `
                <div class="schedule-item">
                    <div class="schedule-info">
                        <span class="schedule-time">${s.scheduled_time}</span>
                        <span> ‚Üí ${s.original_name}</span>
                    </div>
                    <button class="btn-delete" onclick="deleteScheduledSong(${s.id})">üóëÔ∏è</button>
                </div>
            `).join('') || '<p style="color:#888;text-align:center;">Nenhuma m√∫sica agendada</p>';
        }

        function showToast(message, isError = false) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast show' + (isError ? ' error' : '');
            setTimeout(() => toast.className = 'toast', 3000);
        }

        // Initialize
        connectWebSocket();
        loadMusic();
    </script>
</body>
</html>
